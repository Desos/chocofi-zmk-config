#!/usr/bin/env bash
# Build ZMK firmware for Chocofi keyboard
# Usage: zmk-build [left|right|both]
#
# Examples:
#   zmk-build left    # Build left half only
#   zmk-build right   # Build right half only
#   zmk-build both    # Build both halves (default)
#   zmk-build         # Same as 'both'

set -euo pipefail

# Chocofi configuration (hardcoded - you only have one keyboard!)
BOARD="nice_nano_v2"
SHIELD="corne"  # Chocofi uses Corne shield

# Determine script location and derive paths
SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
SCRIPT_DIR="$(dirname "$SCRIPT_PATH")"
ZMK_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
ZMK_SOURCE="$ZMK_ROOT/Source/zmk"
CONFIG_DIR="$ZMK_ROOT/config"

# Parse argument (side)
SIDE="${1:-both}"

# Validate argument
if [[ ! "$SIDE" =~ ^(left|right|both)$ ]]; then
    echo "Usage: zmk-build [left|right|both]"
    echo ""
    echo "Examples:"
    echo "  zmk-build left    # Build left half"
    echo "  zmk-build right   # Build right half"
    echo "  zmk-build both    # Build both halves (default)"
    exit 1
fi

# Check if ZMK source exists
if [ ! -d "$ZMK_SOURCE" ]; then
    echo "Error: ZMK source not found at $ZMK_SOURCE"
    echo "Run: cd $ZMK_ROOT && git submodule update --init --recursive"
    exit 1
fi

# Check if config directory exists
if [ ! -d "$CONFIG_DIR" ]; then
    echo "Error: Config directory not found at $CONFIG_DIR"
    exit 1
fi

# Build container image if it doesn't exist
if ! podman image exists zmk-dev; then
    echo "Building ZMK container image..."
    podman build -t zmk-dev \
        -f "$ZMK_SOURCE/.devcontainer/Dockerfile" \
        "$ZMK_SOURCE/.devcontainer"
fi

# Function to build a single side
build_side() {
    local side=$1
    local build_dir="build/$side"
    local shield_name="${SHIELD}_${side}"
    
    # Explicitly specify keymap file for both halves
    local snippet_args=""
    local cmake_args="-DZMK_CONFIG=/workspaces/zmk-config -DKEYMAP_FILE=/workspaces/zmk-config/chocofi.keymap"
    
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "Building Chocofi - ${side^^} Half"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "  Board:      $BOARD"
    echo "  Shield:     $shield_name"
    echo "  Build dir:  $build_dir"
    echo "  Keymap:     chocofi.keymap"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    
    # Run build in container
    podman run -it --rm \
        --security-opt label=disable \
        --workdir /workspaces/zmk/app \
        -v "$ZMK_SOURCE:/workspaces/zmk:z" \
        -v "$CONFIG_DIR:/workspaces/zmk-config:z" \
        zmk-dev \
        west build -d "$build_dir" -b "$BOARD" $snippet_args -- \
            -DSHIELD="$shield_name" \
            $cmake_args
    
    local status=$?
    
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    if [ $status -eq 0 ]; then
        echo "✓ ${side^^} half build successful!"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo ""
        echo "Firmware: $ZMK_SOURCE/app/$build_dir/zephyr/zmk.uf2"
    else
        echo "✗ ${side^^} half build failed!"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        return $status
    fi
    
    return 0
}

# Build requested side(s)
if [ "$SIDE" = "both" ]; then
    build_side "left" || exit 1
    echo ""
    build_side "right" || exit 1
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "✓ Both halves built successfully!"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo "Flash firmware:"
    echo "  Left:  $ZMK_SOURCE/app/build/left/zephyr/zmk.uf2"
    echo "  Right: $ZMK_SOURCE/app/build/right/zephyr/zmk.uf2"
else
    build_side "$SIDE"
fi
